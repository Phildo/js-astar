<html>
<head>
<script type='text/javascript' src='registrationlist.js'></script>
<script type='text/javascript' src='binarytree.js'></script>
<script type='text/javascript' src='canv.js'></script>
<script type='text/javascript' src='astar.js'></script>
<script type='text/javascript'>
var c = new Canv(500,500);
c.canvas.style.border = "1px solid black";

var map;
var n = 30;

var rx, ry;

var nodes;
var you;
var end;
var step;

var blockQueue = new RegistrationList("CLICK_QUEUE");
var unblockQueue = new RegistrationList("CLICK_QUEUE");
var shiftDown = false;
var pt;

function doit()
{
  document.getElementById("canvas_container").appendChild(c.canvas);

  AStarNode.prototype.calculateH = function(node) 
  { 
    this.h = 50*(Math.abs(node.content.x-this.content.x)+Math.abs(node.content.y-this.content.y)); 
  };
  AStarNode.prototype.calculateGFrom = function(node)
  {
    return node.g+node.content.height-this.content.height;
  };

  map = new Map("Test");
  nodes = map.constructGrid(n,n);
  you = nodes[0][0];
  end = nodes[0][0];
  
  tick();
}

function tick()
{
  while(pt = blockQueue.firstMember())
  {
    var x = Math.floor((pt.x/c.canvas.width)*n);
    var y = Math.floor((pt.y/c.canvas.width)*n);
    if(x >= 0 && x < n && y >= 0 && y < n && 
       nodes[x][y] != you && nodes[x][y] != end &&
       !nodes[x][y].content.block)
    {
          nodes[x][y].disallowPassage();
          nodes[x][y].content.block = true;;
    }
    blockQueue.unregister(pt);
  }
  while(pt = unblockQueue.firstMember())
  {
    var x = Math.floor((pt.x/c.canvas.width)*n);
    var y = Math.floor((pt.y/c.canvas.width)*n);
    if(x >= 0 && x < n && y >= 0 && y < n && 
       nodes[x][y] != you && nodes[x][y] != end &&
       nodes[x][y].content.block)
    {
          nodes[x][y].allowPassage();
          nodes[x][y].content.block = false;;
    }
    blockQueue.unregister(pt);
  }
  
  while(you == end) setRandomEnd();
  step = map.getBestStep(you,end);
  if(step) you = step;
  draw();
  setTimeout(tick, 10);
}

function draw()
{
  for(var i = 0; i < n; i++)
  {
    for(var j = 0; j < n; j++)
    {
      if(nodes[i][j] == end) c.context.fillStyle = "#FF0000";
      else if(nodes[i][j] == you) c.context.fillStyle = "#00FF00";
      else if(nodes[i][j].content.block) c.context.fillStyle = "#555555";
      else c.context.fillStyle = "#000000"; //{ var h = Math.floor(nodes[i][j].height/10); c.context.fillStyle == "#"+h+""+h+""+h; }
      c.context.fillRect((i/n)*c.canvas.width,(j/n)*c.canvas.height,(1/n)*c.canvas.width,(1/n)*c.canvas.height);
    }
  }
};

function setRandomEnd()
{
  rx = Math.floor(Math.random()*n);
  ry = Math.floor(Math.random()*n);
  while(nodes[rx][ry].content.block == true)
  {
    rx = Math.floor(Math.random()*n);
    ry = Math.floor(Math.random()*n);
  }

  end = nodes[rx][ry];
};

function addToBlockQueue(e)
{
  blockQueue.register({"x":e.x-c.canvas.offsetLeft,"y":e.y-c.canvas.offsetTop});
};

function addToUnblockQueue(e)
{
  unblockQueue.register({"x":e.x-c.canvas.offsetLeft,"y":e.y-c.canvas.offsetTop});
};

function startBlocking(e)
{
  if(!shiftDown)
  {
    window.addEventListener('mousemove', addToBlockQueue, false);
    addToBlockQueue(e);
  }
  else if(shiftDown)
  {
    window.addEventListener('mousemove', addToUnblockQueue, false);
    addToUnblockQueue(e);
    e.stopPropagation();
  }
};

function stopBlocking(e)
{
  if(!shiftDown)
    window.removeEventListener('mousemove', addToBlockQueue, false);
  else if(shiftDown)
  {
    window.removeEventListener('mousemove', addToUnblockQueue, false);
    e.stopPropagation();
  }
};

function downShift(e)
{
  if(e.keyCode == 16) shiftDown = true;
};
function upShift(e)
{
  if(e.keyCode == 16) shiftDown = false;
};

window.addEventListener('load',doit,false);
document.addEventListener('mousedown', startBlocking, false);
document.addEventListener('mouseup', stopBlocking, false);
document.addEventListener('keydown', downShift, false);
document.addEventListener('keyup', upShift, false);
</script>
</head>
<body >
  <div id="canvas_container">
  </div>
</body>
</html>
